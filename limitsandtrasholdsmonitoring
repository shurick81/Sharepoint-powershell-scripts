$webApplicationsLimit = @( 20, 15 )
$HNSCMPLimit = @( 20, 15 )
$alternativeUrlsLimit = @( 5, 4 )
$PBSCMPLimit = @( 20, 15 )

$emailAddress = "alexander.sapozhkov@telecomputing.no"
$from = "limits-checker@telecomputing.no"
$SMTPServer = "mx01.telecomputing.no"
$SMTPPort = "25"

$body = ""
$alarm = $false
[System.Reflection.Assembly]::LoadWithPartialName( "Microsoft.SharePoint" )
Add-PSSnapin Microsoft.SharePoint.PowerShell
$was = Get-SPWebApplication
if ( $was.count -ge $webApplicationsLimit[1] )
{
	if ( $was.count -ge $webApplicationsLimit[0] )
	{
		$body = $body + 'ALARM:<br>'
		$alarm = $true
	}
	$body = $body + 'Number of web applications is ' + $was.count + '<br>'
}
$HNSCMP = Get-SPManagedPath -HostHeader
if ( $HNSCMP.count -ge $HNSCMPLimit[1] )
{
	if ( $HNSCMP.count -ge $HNSCMPLimit[0] )
	{
		$body = $body + 'ALARM:<br>'
		$alarm = $true
	}
	$body = $body + 'Number of HNSC managed paths is ' + $HNSCMP.count + '<br>'
}
ForEach ( $wa in $was )
{
	$urls = $wa.AlternateUrls
	if ( $urls.count -ge $alternativeUrlsLimit[1] )
	{
		if ( $urls.count -ge $alternativeUrlsLimit[0] )
		{
			$body = $body + 'ALARM:<br>'
			$alarm = $true
		}
		$body = $body + 'Web application ' + $wa.Name + ' has ' + $urls.count + ' alternative mappings<br>'
	}
	$PBSCMP = $wa | Get-SPManagedPath
	if ( $PBSCMP.count -ge $PBSCMPLimit[1] )
	{
		if ( $PBSCMP.count -ge $PBSCMPLimit[0] )
		{
			$body = $body + 'ALARM:<br>'
			$alarm = $true
		}
		$body = $body + 'Web application ' + $wa.Name + ' has ' + $PBSCMP.count + ' managed paths<br>'
	}
}
  
if ( $body -ne "" )
{
	$body = 'Server: ' + $env:computername + '<br>' + $body
	"Sending Email"
	$subject = "Some limits are about to be crossed"
	if ( $alarm ) { $subject = "ALARM! Some limits are crossed" }
	Send-MailMessage -From $from -to $emailAddress -Subject $Subject -Body $Body -SmtpServer $SMTPServer -port $SMTPPort -UseSsl -BodyAsHTML
}

