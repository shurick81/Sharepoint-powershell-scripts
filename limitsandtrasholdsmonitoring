# Tested on SharePoint 2013

$webApplicationsLimit = @( 20, 15 )
$HNSCMPLimit = @( 20, 15 )
$alternativeUrlsLimit = @( 5, 4 )
$PBSCMPLimit = @( 20, 15 )
$appPoolsLimit = @( 10, 7 )
$contentDatabasesLimit = @( 500, 450 )
$contentDatabaseSizeLimit = @( 200, 150 ) #Gigs
$itemsLimit = @( 5000, 4000 )

$emailAddress = "alexander.sapozhkov@telecomputing.no"
$from = "limits-checker@telecomputing.no"
$SMTPServer = "mx01.telecomputing.no"
$SMTPPort = "25"

$body = ""
$alarm = $false
[System.Reflection.Assembly]::LoadWithPartialName( "Microsoft.SharePoint" )
Add-PSSnapin Microsoft.SharePoint.PowerShell
$was = Get-SPWebApplication
if ( $was.count -ge $webApplicationsLimit[1] )
{
	if ( $was.count -ge $webApplicationsLimit[0] )
	{
		$body = $body + 'ALARM:<br>'
		$alarm = $true
	}
	$body = $body + 'Number of web applications is ' + $was.count + '<br>'
}
$HNSCMP = Get-SPManagedPath -HostHeader
if ( $HNSCMP.count -ge $HNSCMPLimit[1] )
{
	if ( $HNSCMP.count -ge $HNSCMPLimit[0] )
	{
		$body = $body + 'ALARM:<br>'
		$alarm = $true
	}
	$body = $body + 'Number of HNSC managed paths is ' + $HNSCMP.count + '<br>'
}
$contentDatabases = Get-SPContentDatabase
if ( $contentDatabases.count -ge $contentDatabasesLimit[1] )
{
	if ( $contentDatabases.count -ge $contentDatabasesLimit[0] )
	{
		$body = $body + 'ALARM:<br>'
		$alarm = $true
	}
	$body = $body + 'Number of content databases is ' + $contentDatabases.count + '<br>'
}
ForEach ( $contentDatabase in $contentDatabases )
{
	$contentDatabaseSize = $contentDatabase.DiskSizeRequired/1024/1024/1024
	if ( $contentDatabaseSize -ge $contentDatabaseSizeLimit[1] )
	{
		if ( $contentDatabaseSize -ge $contentDatabaseSizeLimit[0] )
		{
			$body = $body + 'ALARM:<br>'
			$alarm = $true
		}
		$body = $body + 'Database ' + $contentDatabase.Name + ' size is ' + $contentDatabaseSize + ' gigabytes<br>'
	}
}
$appPoolsCount = ( [Microsoft.SharePoint.Administration.SPWebService]::ContentService.ApplicationPools ).count + ( Get-SPServiceApplicationPool ).count
if ( $appPoolsCount -ge $appPoolsLimit[1] )
{
	if ( $appPoolsCount -ge $appPoolsLimit[0] )
	{
		$body = $body + 'ALARM:<br>'
		$alarm = $true
	}
	$body = $body + 'Number of application pools is ' + $appPoolsCount + '<br>'
}
ForEach ( $wa in $was )
{
	$urls = $wa.AlternateUrls
	if ( $urls.count -ge $alternativeUrlsLimit[1] )
	{
		if ( $urls.count -ge $alternativeUrlsLimit[0] )
		{
			$body = $body + 'ALARM:<br>'
			$alarm = $true
		}
		$body = $body + 'Web application ' + $wa.Name + ' has ' + $urls.count + ' alternative mappings<br>'
	}
	$PBSCMP = $wa | Get-SPManagedPath
	if ( $PBSCMP.count -ge $PBSCMPLimit[1] )
	{
		if ( $PBSCMP.count -ge $PBSCMPLimit[0] )
		{
			$body = $body + 'ALARM:<br>'
			$alarm = $true
		}
		$body = $body + 'Web application ' + $wa.Name + ' has ' + $PBSCMP.count + ' managed paths<br>'
	}
}
$lists = Get-SPSite -Limit All | % { Get-SPWeb -Site $_ -Limit All } | % { $_.Lists }
ForEach ( $list in $lists )
{
	$itemsCount = $list.Items.Count
	if ( $itemsCount -ge $itemsLimit[1] )
	{
		if ( $itemsCount -ge $itemsLimit[0] )
		{
			$body = $body + 'ALARM:<br>'
			$alarm = $true
		}
		$body = $body + 'List ' + $list.ParentWeb.Url + $list.RootFolder.ServerRelativeUrl + ' has ' + $itemsCount + ' items<br>'
	}
}
  
if ( $body -ne "" )
{
	$body = 'Server: ' + $env:computername + '<br>' + $body
	"Sending Email"
	$subject = "Some limits are about to be crossed"
	if ( $alarm ) { $subject = "ALARM! Some limits are crossed" }
	Send-MailMessage -From $from -to $emailAddress -Subject $Subject -Body $Body -SmtpServer $SMTPServer -port $SMTPPort -UseSsl -BodyAsHTML
}

